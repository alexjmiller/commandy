#!/bin/zsh

# commandy - Terminal session launcher
# Provides quick access to common development tasks

PROJECTS_DIR="$HOME/Projects"
HOSTNAME=$(hostname)

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m' # No Color

show_banner() {
    clear
    print ""
    print "${CYAN}╔═══════════════════════════════════════════════════════╗${NC}"
    print "${CYAN}║${NC}                                                       ${CYAN}║${NC}"
    print "${CYAN}║${NC}   ${BLUE}  ####   ####  #    # #    #  ###  #   # ####  #   #${NC} ${CYAN}║${NC}"
    print "${CYAN}║${NC}   ${BLUE} #      #    # ##  ## ##  ## #   # ##  # #   #  # # ${NC} ${CYAN}║${NC}"
    print "${CYAN}║${NC}   ${BLUE} #      #    # # ## # # ## # ##### # # # #   #   #  ${NC} ${CYAN}║${NC}"
    print "${CYAN}║${NC}   ${BLUE} #      #    # #    # #    # #   # #  ## #   #   #  ${NC} ${CYAN}║${NC}"
    print "${CYAN}║${NC}   ${BLUE}  ####   ####  #    # #    # #   # #   # ####    #  ${NC} ${CYAN}║${NC}"
    print "${CYAN}║${NC}                                                       ${CYAN}║${NC}"
    print "${CYAN}║${NC}           ${YELLOW}~ Terminal Session Launcher ~${NC}             ${CYAN}║${NC}"
    print "${CYAN}║${NC}                                                       ${CYAN}║${NC}"
    print "${CYAN}║${NC}                 Host: ${GREEN}$HOSTNAME${NC}                       ${CYAN}║${NC}"
    print "${CYAN}║${NC}                                                       ${CYAN}║${NC}"
    print "${CYAN}╚═══════════════════════════════════════════════════════╝${NC}"
    print ""
}

show_menu() {
    show_banner
    print "  ${CYAN}┌─────────────────────────────────────┐${NC}"
    print "  ${CYAN}│${NC}  ${YELLOW}What would you like to do?${NC}         ${CYAN}│${NC}"
    print "  ${CYAN}├─────────────────────────────────────┤${NC}"
    local i=1
    if [[ "$HOSTNAME" == "mac" ]]; then
        print "  ${CYAN}│${NC}    ${GREEN}$i)${NC} BlueStudio                    ${CYAN}│${NC}"
        ((i++))
    else
        print "  ${CYAN}│${NC}    ${GREEN}$i)${NC} Fintrac                        ${CYAN}│${NC}"
        ((i++))
    fi
    print "  ${CYAN}│${NC}    ${GREEN}$i)${NC} Browse Projects                ${CYAN}│${NC}"
    ((i++))
    print "  ${CYAN}│${NC}    ${GREEN}$i)${NC} Setup New Project              ${CYAN}│${NC}"
    ((i++))
    print "  ${CYAN}│${NC}    ${GREEN}$i)${NC} Tools                          ${CYAN}│${NC}"
    ((i++))
    print "  ${CYAN}│${NC}    ${GREEN}$i)${NC} Skip                           ${CYAN}│${NC}"
    print "  ${CYAN}└─────────────────────────────────────┘${NC}"
    print ""
}

bluestudio_menu() {
    print ""
    print "${BLUE}BlueStudio:${NC}"
    print ""
    print "  ${GREEN}1)${NC} Start (both services)"
    print "  ${GREEN}2)${NC} Stop all services"
    print "  ${GREEN}3)${NC} Restart all services"
    print "  ${GREEN}4)${NC} Check status"
    print "  ${GREEN}5)${NC} View API logs"
    print "  ${GREEN}6)${NC} View Dashboard logs"
    print "  ${GREEN}7)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1)
            print "${YELLOW}Starting BlueStudio...${NC}"
            bluestudio
            ;;
        2)
            print "${YELLOW}Stopping BlueStudio...${NC}"
            bluestudio stop
            ;;
        3)
            print "${YELLOW}Restarting BlueStudio...${NC}"
            bluestudio restart
            ;;
        4)
            bluestudio status
            print ""
            read "?Press Enter to continue..."
            bluestudio_menu
            ;;
        5)
            bluestudio logs api
            ;;
        6)
            bluestudio logs dashboard
            ;;
        7)
            return
            ;;
        *)
            print "Invalid choice"
            bluestudio_menu
            ;;
    esac
}

fintrac_menu() {
    print ""
    print "${BLUE}Fintrac:${NC}"
    print ""
    print "  ${GREEN}1)${NC} Start (all services)"
    print "  ${GREEN}2)${NC} Stop all services"
    print "  ${GREEN}3)${NC} Restart all services"
    print "  ${GREEN}4)${NC} Check status"
    print "  ${GREEN}5)${NC} View Backend logs"
    print "  ${GREEN}6)${NC} View Frontend logs"
    print "  ${GREEN}7)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1)
            print "${YELLOW}Starting Fintrac...${NC}"
            "$PROJECTS_DIR/fintrac/fintrac" start
            print ""
            read "?Press Enter to continue..."
            fintrac_menu
            ;;
        2)
            print "${YELLOW}Stopping Fintrac...${NC}"
            "$PROJECTS_DIR/fintrac/fintrac" stop
            print ""
            read "?Press Enter to continue..."
            fintrac_menu
            ;;
        3)
            print "${YELLOW}Restarting Fintrac...${NC}"
            "$PROJECTS_DIR/fintrac/fintrac" restart
            print ""
            read "?Press Enter to continue..."
            fintrac_menu
            ;;
        4)
            "$PROJECTS_DIR/fintrac/fintrac" status
            print ""
            read "?Press Enter to continue..."
            fintrac_menu
            ;;
        5)
            "$PROJECTS_DIR/fintrac/fintrac" logs backend
            ;;
        6)
            "$PROJECTS_DIR/fintrac/fintrac" logs frontend
            ;;
        7)
            return
            ;;
        *)
            print "Invalid choice"
            fintrac_menu
            ;;
    esac
}

browse_projects() {
    print ""
    print "${BLUE}Select a project:${NC}"
    print ""

    # Get list of directories in Projects folder
    local projects=()
    local i=1

    for dir in "$PROJECTS_DIR"/*/; do
        if [[ -d "$dir" ]]; then
            local name=$(basename "$dir")
            projects+=("$name")
            print "  ${GREEN}$i)${NC} $name"
            ((i++))
        fi
    done

    print "  ${GREEN}$i)${NC} Back to menu"
    print ""

    read "choice?Enter choice: "

    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice < i )); then
        local selected="${projects[$choice]}"
        local project_path="$PROJECTS_DIR/$selected"

        print ""
        print "${BLUE}Project: ${NC}$selected"
        print ""
        print "  ${GREEN}1)${NC} Open folder"
        print "  ${GREEN}2)${NC} Launch claude-logged"
        print "  ${GREEN}3)${NC} Back"
        print ""

        read "action?Enter choice: "

        case $action in
            1)
                print "${YELLOW}Changing to $project_path${NC}"
                cd "$project_path"
                exec zsh
                ;;
            2)
                print "${YELLOW}Launching claude-logged in $selected...${NC}"
                cd "$project_path"
                claude-logged
                exec zsh
                ;;
            3)
                browse_projects
                ;;
        esac
    elif (( choice == i )); then
        return
    else
        print "Invalid choice"
        browse_projects
    fi
}

setup_new_project() {
    print ""
    print -n "${BLUE}Enter new project name: ${NC}"
    read project_name

    if [[ -z "$project_name" ]]; then
        print "Project name cannot be empty"
        return
    fi

    local project_path="$PROJECTS_DIR/$project_name"

    if [[ -d "$project_path" ]]; then
        print "${YELLOW}Project already exists!${NC}"
        return
    fi

    print "${YELLOW}Creating project: $project_name${NC}"
    mkdir -p "$project_path"
    cd "$project_path"
    git init

    print ""
    print "${GREEN}Project '$project_name' created and initialized with git!${NC}"
    print "${CYAN}Location: $project_path${NC}"
    print ""

    print "  ${GREEN}1)${NC} Start working here"
    print "  ${GREEN}2)${NC} Launch claude-logged"
    print "  ${GREEN}3)${NC} Back to menu"
    print ""

    read "action?Enter choice: "

    case $action in
        1)
            exec zsh
            ;;
        2)
            claude-logged
            exec zsh
            ;;
        3)
            cd - > /dev/null
            return
            ;;
    esac
}

# ============================================
# TOOLS MENU
# ============================================

tools_menu() {
    print ""
    print "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    print "${BLUE}  Tools${NC}"
    print "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    print ""
    print "  ${GREEN}1)${NC} Quick Access"
    print "  ${GREEN}2)${NC} Dev Tools"
    print "  ${GREEN}3)${NC} Port Authority"
    print "  ${GREEN}4)${NC} System Maintenance"
    print "  ${GREEN}5)${NC} NPM Utilities"
    print "  ${GREEN}6)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1) quick_access_menu ;;
        2) dev_tools_menu ;;
        3) port_authority_menu ;;
        4) system_maintenance_menu ;;
        5) npm_utilities_menu ;;
        6) return ;;
        *) print "Invalid choice"; tools_menu ;;
    esac
}

# ============================================
# QUICK ACCESS
# ============================================

quick_access_menu() {
    print ""
    print "${BLUE}Quick Access:${NC}"
    print ""
    if [[ "$HOSTNAME" == "mac" ]]; then
        print "  ${GREEN}1)${NC} SSH to MacBookPro"
    else
        print "  ${GREEN}1)${NC} SSH to mac"
    fi
    print "  ${GREEN}2)${NC} Open GitHub"
    print "  ${GREEN}3)${NC} Prisma Studio (select project)"
    print "  ${GREEN}4)${NC} PostgreSQL shell"
    print "  ${GREEN}5)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1)
            if [[ "$HOSTNAME" == "mac" ]]; then
                print "${YELLOW}Connecting to MacBookPro...${NC}"
                ssh alexander@MacBookPro.local
            else
                print "${YELLOW}Connecting to mac...${NC}"
                ssh alexander@mac.local
            fi
            ;;
        2)
            print "${YELLOW}Opening GitHub...${NC}"
            open "https://github.com"
            quick_access_menu
            ;;
        3)
            select_project_for "prisma_studio"
            ;;
        4)
            print ""
            print -n "${BLUE}Database URL (or press Enter for fintrac): ${NC}"
            read db_url
            if [[ -z "$db_url" ]]; then
                print "${YELLOW}Connecting to Fintrac PostgreSQL...${NC}"
                psql "postgresql://postgres:postgres@localhost:5432/fintrac"
            else
                psql "$db_url"
            fi
            quick_access_menu
            ;;
        5)
            tools_menu
            ;;
        *)
            print "Invalid choice"
            quick_access_menu
            ;;
    esac
}

# ============================================
# DEV TOOLS
# ============================================

dev_tools_menu() {
    print ""
    print "${BLUE}Dev Tools:${NC}"
    print ""
    print "  ${GREEN}1)${NC} Kill process on port"
    print "  ${GREEN}2)${NC} Check port usage"
    print "  ${GREEN}3)${NC} Start ngrok"
    print "  ${GREEN}4)${NC} Git status (all projects)"
    print "  ${GREEN}5)${NC} Git pull (all projects)"
    print "  ${GREEN}6)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1)
            print ""
            print -n "${BLUE}Enter port number: ${NC}"
            read port
            if [[ -n "$port" ]]; then
                local pid=$(lsof -ti:$port 2>/dev/null)
                if [[ -n "$pid" ]]; then
                    print "${YELLOW}Killing process $pid on port $port...${NC}"
                    kill -9 $pid
                    print "${GREEN}Done${NC}"
                else
                    print "${CYAN}No process found on port $port${NC}"
                fi
            fi
            print ""
            read "?Press Enter to continue..."
            dev_tools_menu
            ;;
        2)
            print ""
            print -n "${BLUE}Enter port number (or leave empty for common ports): ${NC}"
            read port
            print ""
            if [[ -n "$port" ]]; then
                print "${CYAN}Port $port:${NC}"
                lsof -i:$port 2>/dev/null || print "  Not in use"
            else
                print "${CYAN}Common ports:${NC}"
                for p in 3000 3012 5173 5432 6379 8080; do
                    local proc=$(lsof -ti:$p 2>/dev/null)
                    if [[ -n "$proc" ]]; then
                        print "  ${GREEN}$p${NC}: PID $proc"
                    else
                        print "  ${CYAN}$p${NC}: available"
                    fi
                done
            fi
            print ""
            read "?Press Enter to continue..."
            dev_tools_menu
            ;;
        3)
            print ""
            print -n "${BLUE}Enter port to expose (default 3012): ${NC}"
            read port
            port=${port:-3012}
            print "${YELLOW}Starting ngrok on port $port...${NC}"
            ngrok http $port
            dev_tools_menu
            ;;
        4)
            print ""
            print "${CYAN}Git status for all projects:${NC}"
            print ""
            for dir in "$PROJECTS_DIR"/*/; do
                if [[ -d "$dir/.git" ]]; then
                    local name=$(basename "$dir")
                    local status=$(cd "$dir" && git status --porcelain 2>/dev/null)
                    local branch=$(cd "$dir" && git branch --show-current 2>/dev/null)
                    if [[ -n "$status" ]]; then
                        print "  ${YELLOW}$name${NC} ($branch) - has changes"
                    else
                        print "  ${GREEN}$name${NC} ($branch) - clean"
                    fi
                fi
            done
            print ""
            read "?Press Enter to continue..."
            dev_tools_menu
            ;;
        5)
            print ""
            print "${CYAN}Pulling all projects:${NC}"
            print ""
            for dir in "$PROJECTS_DIR"/*/; do
                if [[ -d "$dir/.git" ]]; then
                    local name=$(basename "$dir")
                    print -n "  ${BLUE}$name${NC}: "
                    (cd "$dir" && git pull --quiet 2>/dev/null && print "${GREEN}updated${NC}") || print "${RED}failed${NC}"
                fi
            done
            print ""
            read "?Press Enter to continue..."
            dev_tools_menu
            ;;
        6)
            tools_menu
            ;;
        *)
            print "Invalid choice"
            dev_tools_menu
            ;;
    esac
}

# ============================================
# PORT AUTHORITY
# ============================================

PORT_AUTHORITY_API="http://zynx.lan:3030/api"
PORT_AUTHORITY_DASHBOARD="http://zynx.lan:8000"

port_authority_menu() {
    print ""
    print "${BLUE}Port Authority:${NC}"
    print ""
    print "  ${GREEN}1)${NC} Check project ports"
    print "  ${GREEN}2)${NC} Setup ports for project"
    print "  ${GREEN}3)${NC} Update project port"
    print "  ${GREEN}4)${NC} View all registered ports"
    print "  ${GREEN}5)${NC} Open dashboard"
    print "  ${GREEN}6)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1) pa_check_project ;;
        2) pa_setup_project ;;
        3) pa_update_project ;;
        4) pa_view_all ;;
        5)
            print "${YELLOW}Opening Port Authority dashboard...${NC}"
            open "$PORT_AUTHORITY_DASHBOARD"
            port_authority_menu
            ;;
        6) tools_menu ;;
        *) print "Invalid choice"; port_authority_menu ;;
    esac
}

pa_check_project() {
    print ""
    print "${BLUE}Select a project to check:${NC}"
    print ""

    local projects=()
    local i=1

    for dir in "$PROJECTS_DIR"/*/; do
        if [[ -d "$dir" ]]; then
            local name=$(basename "$dir")
            projects+=("$name")
            print "  ${GREEN}$i)${NC} $name"
            ((i++))
        fi
    done

    print "  ${GREEN}$i)${NC} Back"
    print ""

    read "choice?Enter choice: "

    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice < i )); then
        local project_name="${projects[$choice]}"
        print ""
        print "${CYAN}Checking ports for: ${NC}$project_name"
        print ""

        local response=$(curl -s "$PORT_AUTHORITY_API/ports?project_name=$project_name")

        if [[ "$response" == "[]" ]] || [[ -z "$response" ]]; then
            print "${YELLOW}No ports registered for this project${NC}"
            print ""
            print "Would you like to set up ports now?"
            print "  ${GREEN}1)${NC} Yes, setup ports"
            print "  ${GREEN}2)${NC} No, go back"
            print ""
            read "setup?Enter choice: "
            if [[ "$setup" == "1" ]]; then
                pa_setup_project_for "$project_name"
            else
                port_authority_menu
            fi
        else
            print "${GREEN}Registered ports:${NC}"
            print ""
            echo "$response" | python3 -c "
import json, sys
data = json.load(sys.stdin)
for port in data:
    print(f\"  Port {port['port']}: {port['description']}')
    print(f\"    Host: {port['host']}\")
    print()
" 2>/dev/null || echo "$response" | tr ',' '\n' | tr -d '[]{}\"' | grep -E "port|host|description"
            print ""
            read "?Press Enter to continue..."
            port_authority_menu
        fi
    elif (( choice == i )); then
        port_authority_menu
    else
        print "Invalid choice"
        pa_check_project
    fi
}

pa_setup_project() {
    print ""
    print "${BLUE}Select a project to setup:${NC}"
    print ""

    local projects=()
    local i=1

    for dir in "$PROJECTS_DIR"/*/; do
        if [[ -d "$dir" ]]; then
            local name=$(basename "$dir")
            projects+=("$name")
            print "  ${GREEN}$i)${NC} $name"
            ((i++))
        fi
    done

    print "  ${GREEN}$i)${NC} Back"
    print ""

    read "choice?Enter choice: "

    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice < i )); then
        local project_name="${projects[$choice]}"
        pa_setup_project_for "$project_name"
    elif (( choice == i )); then
        port_authority_menu
    else
        print "Invalid choice"
        pa_setup_project
    fi
}

pa_setup_project_for() {
    local project_name=$1
    local current_host=$(hostname)

    print ""
    print "${CYAN}Setting up ports for: ${NC}$project_name"
    print "${CYAN}Current host: ${NC}$current_host"
    print ""

    # Check existing ports
    local existing=$(curl -s "$PORT_AUTHORITY_API/ports?project_name=$project_name")
    if [[ "$existing" != "[]" ]] && [[ -n "$existing" ]]; then
        print "${YELLOW}Warning: Ports already registered for this project${NC}"
        print ""
        read "cont?Continue anyway? (y/n): "
        if [[ "$cont" != "y" ]]; then
            port_authority_menu
            return
        fi
    fi

    # Get available port
    print "${YELLOW}Fetching available port...${NC}"
    local available=$(curl -s "$PORT_AUTHORITY_API/ports/available?host=$current_host")
    local suggested_port=$(echo "$available" | grep -o '"port":[0-9]*' | cut -d':' -f2)

    if [[ -z "$suggested_port" ]]; then
        suggested_port="3000"
    fi

    print ""
    print -n "${BLUE}Port number (suggested: $suggested_port): ${NC}"
    read port_num
    port_num=${port_num:-$suggested_port}

    print -n "${BLUE}Service description (e.g., 'Vite dev server', 'Express API'): ${NC}"
    read description

    if [[ -z "$description" ]]; then
        description="$project_name development server"
    fi

    print ""
    print "${YELLOW}Registering port...${NC}"

    local result=$(curl -s -X POST "$PORT_AUTHORITY_API/ports/register" \
        -H "Content-Type: application/json" \
        -d "{
            \"host\": \"$current_host\",
            \"port\": $port_num,
            \"project_name\": \"$project_name\",
            \"description\": \"$description\"
        }")

    if echo "$result" | grep -q "error"; then
        print "${RED}Error registering port:${NC}"
        echo "$result"
    else
        print "${GREEN}Port registered successfully!${NC}"
        print ""
        print "  Project: $project_name"
        print "  Port: $port_num"
        print "  Host: $current_host"
        print "  Description: $description"
    fi

    print ""
    read "?Press Enter to continue..."
    port_authority_menu
}

pa_update_project() {
    print ""
    print "${BLUE}Select a project to update:${NC}"
    print ""

    local projects=()
    local i=1

    for dir in "$PROJECTS_DIR"/*/; do
        if [[ -d "$dir" ]]; then
            local name=$(basename "$dir")
            projects+=("$name")
            print "  ${GREEN}$i)${NC} $name"
            ((i++))
        fi
    done

    print "  ${GREEN}$i)${NC} Back"
    print ""

    read "choice?Enter choice: "

    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice < i )); then
        local project_name="${projects[$choice]}"

        print ""
        print "${CYAN}Fetching current registration for: ${NC}$project_name"

        local response=$(curl -s "$PORT_AUTHORITY_API/ports?project_name=$project_name")

        if [[ "$response" == "[]" ]] || [[ -z "$response" ]]; then
            print "${YELLOW}No ports registered for this project${NC}"
            print ""
            read "?Press Enter to continue..."
            port_authority_menu
            return
        fi

        # Extract port ID
        local port_id=$(echo "$response" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
        local current_port=$(echo "$response" | grep -o '"port":[0-9]*' | head -1 | cut -d':' -f2)

        print ""
        print "Current port: $current_port"
        print ""
        print "What would you like to update?"
        print "  ${GREEN}1)${NC} Port number"
        print "  ${GREEN}2)${NC} Description"
        print "  ${GREEN}3)${NC} Delete registration"
        print "  ${GREEN}4)${NC} Back"
        print ""

        read "action?Enter choice: "

        case $action in
            1)
                print -n "${BLUE}New port number: ${NC}"
                read new_port
                if [[ -n "$new_port" ]]; then
                    curl -s -X PATCH "$PORT_AUTHORITY_API/ports/$port_id" \
                        -H "Content-Type: application/json" \
                        -d "{\"port\": $new_port}" > /dev/null
                    print "${GREEN}Port updated to $new_port${NC}"
                fi
                ;;
            2)
                print -n "${BLUE}New description: ${NC}"
                read new_desc
                if [[ -n "$new_desc" ]]; then
                    curl -s -X PATCH "$PORT_AUTHORITY_API/ports/$port_id" \
                        -H "Content-Type: application/json" \
                        -d "{\"description\": \"$new_desc\"}" > /dev/null
                    print "${GREEN}Description updated${NC}"
                fi
                ;;
            3)
                print -n "${RED}Are you sure you want to delete this registration? (y/n): ${NC}"
                read confirm
                if [[ "$confirm" == "y" ]]; then
                    curl -s -X DELETE "$PORT_AUTHORITY_API/ports/$port_id" > /dev/null
                    print "${GREEN}Registration deleted${NC}"
                fi
                ;;
            4)
                port_authority_menu
                return
                ;;
        esac

        print ""
        read "?Press Enter to continue..."
        port_authority_menu
    elif (( choice == i )); then
        port_authority_menu
    else
        print "Invalid choice"
        pa_update_project
    fi
}

pa_view_all() {
    print ""
    print "${CYAN}All registered ports:${NC}"
    print ""

    local response=$(curl -s "$PORT_AUTHORITY_API/ports")

    if [[ "$response" == "[]" ]] || [[ -z "$response" ]]; then
        print "${YELLOW}No ports registered${NC}"
    else
        # Format output nicely
        print "${CYAN}┌──────┬────────────────────┬──────────────────────────────────┐${NC}"
        print "${CYAN}│${NC} Port ${CYAN}│${NC} Project            ${CYAN}│${NC} Host                             ${CYAN}│${NC}"
        print "${CYAN}├──────┼────────────────────┼──────────────────────────────────┤${NC}"

        echo "$response" | python3 -c "
import json, sys
data = json.load(sys.stdin)
for port in sorted(data, key=lambda x: x['port']):
    p = str(port['port']).ljust(4)
    proj = port.get('project_name', 'N/A')[:18].ljust(18)
    host = port.get('host', 'N/A')[:32].ljust(32)
    print(f'│ {p} │ {proj} │ {host} │')
" 2>/dev/null || echo "$response"

        print "${CYAN}└──────┴────────────────────┴──────────────────────────────────┘${NC}"
    fi

    print ""
    read "?Press Enter to continue..."
    port_authority_menu
}

# ============================================
# SYSTEM MAINTENANCE
# ============================================

system_maintenance_menu() {
    print ""
    print "${BLUE}System Maintenance:${NC}"
    print ""
    print "  ${GREEN}1)${NC} Docker cleanup"
    print "  ${GREEN}2)${NC} Homebrew update"
    print "  ${GREEN}3)${NC} Clear npm cache"
    print "  ${GREEN}4)${NC} Remove node_modules (select project)"
    print "  ${GREEN}5)${NC} Clear all caches"
    print "  ${GREEN}6)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1)
            print ""
            print "${YELLOW}Docker cleanup...${NC}"
            print ""
            print "  Removing stopped containers..."
            docker container prune -f
            print "  Removing unused images..."
            docker image prune -f
            print "  Removing unused volumes..."
            docker volume prune -f
            print "  Removing unused networks..."
            docker network prune -f
            print ""
            print "${GREEN}Docker cleanup complete${NC}"
            docker system df
            print ""
            read "?Press Enter to continue..."
            system_maintenance_menu
            ;;
        2)
            print ""
            print "${YELLOW}Updating Homebrew...${NC}"
            brew update
            print ""
            print "${YELLOW}Upgrading packages...${NC}"
            brew upgrade
            print ""
            print "${YELLOW}Cleaning up...${NC}"
            brew cleanup
            print ""
            print "${GREEN}Homebrew update complete${NC}"
            print ""
            read "?Press Enter to continue..."
            system_maintenance_menu
            ;;
        3)
            print ""
            print "${YELLOW}Clearing npm cache...${NC}"
            npm cache clean --force
            print "${GREEN}npm cache cleared${NC}"
            print ""
            read "?Press Enter to continue..."
            system_maintenance_menu
            ;;
        4)
            select_project_for "remove_node_modules"
            ;;
        5)
            print ""
            print "${YELLOW}Clearing all caches...${NC}"
            print ""
            print "  npm cache..."
            npm cache clean --force
            print "  Homebrew cache..."
            brew cleanup -s
            print "  .DS_Store files..."
            find "$PROJECTS_DIR" -name ".DS_Store" -delete 2>/dev/null
            print ""
            print "${GREEN}All caches cleared${NC}"
            print ""
            read "?Press Enter to continue..."
            system_maintenance_menu
            ;;
        6)
            tools_menu
            ;;
        *)
            print "Invalid choice"
            system_maintenance_menu
            ;;
    esac
}

# ============================================
# NPM UTILITIES
# ============================================

npm_utilities_menu() {
    print ""
    print "${BLUE}NPM Utilities:${NC}"
    print ""
    print "  ${GREEN}1)${NC} npm audit (select project)"
    print "  ${GREEN}2)${NC} npm outdated (select project)"
    print "  ${GREEN}3)${NC} npm update (select project)"
    print "  ${GREEN}4)${NC} npm dedupe (select project)"
    print "  ${GREEN}5)${NC} npm install (select project)"
    print "  ${GREEN}6)${NC} Check outdated (all projects)"
    print "  ${GREEN}7)${NC} Back"
    print ""

    read "choice?Enter choice: "

    case $choice in
        1) select_project_for "npm_audit" ;;
        2) select_project_for "npm_outdated" ;;
        3) select_project_for "npm_update" ;;
        4) select_project_for "npm_dedupe" ;;
        5) select_project_for "npm_install" ;;
        6)
            print ""
            print "${CYAN}Checking outdated packages in all projects:${NC}"
            print ""
            for dir in "$PROJECTS_DIR"/*/; do
                if [[ -f "$dir/package.json" ]]; then
                    local name=$(basename "$dir")
                    print "${BLUE}━━━ $name ━━━${NC}"
                    (cd "$dir" && npm outdated 2>/dev/null) || print "  No outdated packages"
                    print ""
                fi
                # Check subdirectories (frontend/backend)
                for subdir in "$dir"*/; do
                    if [[ -f "$subdir/package.json" ]]; then
                        local subname="$(basename "$dir")/$(basename "$subdir")"
                        print "${BLUE}━━━ $subname ━━━${NC}"
                        (cd "$subdir" && npm outdated 2>/dev/null) || print "  No outdated packages"
                        print ""
                    fi
                done
            done
            read "?Press Enter to continue..."
            npm_utilities_menu
            ;;
        7)
            tools_menu
            ;;
        *)
            print "Invalid choice"
            npm_utilities_menu
            ;;
    esac
}

# ============================================
# PROJECT SELECTOR HELPER
# ============================================

select_project_for() {
    local action=$1
    print ""
    print "${BLUE}Select a project:${NC}"
    print ""

    local projects=()
    local i=1

    # Add projects with package.json
    for dir in "$PROJECTS_DIR"/*/; do
        if [[ -f "$dir/package.json" ]]; then
            local name=$(basename "$dir")
            projects+=("$dir")
            print "  ${GREEN}$i)${NC} $name"
            ((i++))
        fi
        # Check for subdirectories with package.json (monorepos)
        for subdir in "$dir"*/; do
            if [[ -f "$subdir/package.json" ]]; then
                local subname="$(basename "$dir")/$(basename "$subdir")"
                projects+=("$subdir")
                print "  ${GREEN}$i)${NC} $subname"
                ((i++))
            fi
        done
    done

    print "  ${GREEN}$i)${NC} Back"
    print ""

    read "choice?Enter choice: "

    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice < i )); then
        local selected="${projects[$choice]}"

        case $action in
            prisma_studio)
                print "${YELLOW}Starting Prisma Studio in $selected...${NC}"
                (cd "$selected" && npx prisma studio)
                quick_access_menu
                ;;
            remove_node_modules)
                print "${YELLOW}Removing node_modules from $selected...${NC}"
                rm -rf "$selected/node_modules"
                print "${GREEN}Done${NC}"
                print ""
                read "?Press Enter to continue..."
                system_maintenance_menu
                ;;
            npm_audit)
                print ""
                print "${CYAN}Running npm audit...${NC}"
                print ""
                (cd "$selected" && npm audit)
                print ""
                read "?Press Enter to continue..."
                npm_utilities_menu
                ;;
            npm_outdated)
                print ""
                print "${CYAN}Checking outdated packages...${NC}"
                print ""
                (cd "$selected" && npm outdated)
                print ""
                read "?Press Enter to continue..."
                npm_utilities_menu
                ;;
            npm_update)
                print ""
                print "${YELLOW}Updating packages...${NC}"
                (cd "$selected" && npm update)
                print ""
                print "${GREEN}Done${NC}"
                print ""
                read "?Press Enter to continue..."
                npm_utilities_menu
                ;;
            npm_dedupe)
                print ""
                print "${YELLOW}Deduplicating packages...${NC}"
                (cd "$selected" && npm dedupe)
                print ""
                print "${GREEN}Done${NC}"
                print ""
                read "?Press Enter to continue..."
                npm_utilities_menu
                ;;
            npm_install)
                print ""
                print "${YELLOW}Installing packages...${NC}"
                (cd "$selected" && npm install)
                print ""
                print "${GREEN}Done${NC}"
                print ""
                read "?Press Enter to continue..."
                npm_utilities_menu
                ;;
        esac
    elif (( choice == i )); then
        case $action in
            prisma_studio) quick_access_menu ;;
            remove_node_modules) system_maintenance_menu ;;
            *) npm_utilities_menu ;;
        esac
    else
        print "Invalid choice"
        select_project_for $action
    fi
}

# Main loop
main() {
    while true; do
        show_menu
        read "choice?Enter choice: "

        if [[ "$HOSTNAME" == "mac" ]]; then
            case $choice in
                1)
                    bluestudio_menu
                    ;;
                2)
                    browse_projects
                    ;;
                3)
                    setup_new_project
                    ;;
                4)
                    tools_menu
                    ;;
                5|"")
                    print "${CYAN}Have a great session!${NC}"
                    break
                    ;;
                *)
                    print "Invalid choice, please try again"
                    ;;
            esac
        else
            case $choice in
                1)
                    fintrac_menu
                    ;;
                2)
                    browse_projects
                    ;;
                3)
                    setup_new_project
                    ;;
                4)
                    tools_menu
                    ;;
                5|"")
                    print "${CYAN}Have a great session!${NC}"
                    break
                    ;;
                *)
                    print "Invalid choice, please try again"
                    ;;
            esac
        fi
    done
}

main
